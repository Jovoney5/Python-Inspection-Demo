<!DOCTYPE html>
<html>
<head>
    <title>Admin Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body {
            font-family: Arial, sans-serif;
            background: url('{{ url_for("static", filename="heart2.jpg") }}') no-repeat center center fixed;
            background-size: cover;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        canvas {
            max-height: 400px;
        }
        .chat-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
        }
        .chat-icon {
            background-color: #00ffff;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 0 10px rgba(0, 255, 255, 0.5);
            position: relative;
        }
        .chat-icon-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: #ff0000;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            display: none;
        }
        .chat-window {
            display: none;
            width: 300px;
            height: 400px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.3);
            flex-direction: column;
        }
        .chat-window.open {
            display: flex;
        }
        .chat-header {
            background: #00b7b7;
            color: white;
            padding: 10px;
            border-top-left-radius: 8px;
            border-top-right-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .chat-body {
            flex: 1;
            padding: 10px;
            overflow-y: auto;
            background: #f9f9f9;
            display: flex;
            flex-direction: column;
        }
        .chat-footer {
            padding: 10px;
            border-top: 1px solid #ddd;
            display: flex;
            gap: 5px;
        }
        .chat-tab-container {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            padding: 5px 0;
            order: 2;
        }
        .chat-tab {
            background: #00b7b7;
            color: white;
            padding: 8px 25px 8px 15px;
            border-radius: 5px 5px 0 0;
            cursor: pointer;
            margin-right: 5px;
            display: inline-flex;
            align-items: center;
            position: relative;
            font-size: 14px;
        }
        .chat-tab.active {
            background: #008080;
        }
        .chat-tab-close {
            position: absolute;
            right: 5px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 12px;
            cursor: pointer;
            padding: 2px;
        }
        .chat-tab-close:hover {
            color: #ff5555;
        }
        .chat-message {
            margin: 5px;
            padding: 8px;
            border-radius: 5px;
        }
        .chat-message.sent {
            background: #00ffff;
            color: black;
            margin-left: 20%;
            text-align: right;
        }
        .chat-message.received {
            background: #e0e0e0;
            margin-right: 20%;
        }
        .contact-list {
            display: none;
            position: absolute;
            bottom: 60px;
            right: 0;
            width: 200px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.2);
            padding: 10px;
            z-index: 1001;
        }
        .contact-list.open {
            display: block;
        }
        .contact-item {
            padding: 8px;
            cursor: pointer;
            border-radius: 5px;
            position: relative;
        }
        .contact-item:hover {
            background: #f0f0f0;
        }
        .contact-item.selected {
            background: #00b7b7;
            color: white;
        }
        .unread-badge {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            background: #ff0000;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
        }
        .black-bold {
            color: #000000;
            font-weight: bold;
        }
        .blue-bold-select {
            background: rgba(255, 255, 255, 0.1);
            color: #0000FF;
            border: 1px solid #0000FF;
            transition: box-shadow 0.3s;
        }
        .blue-bold-select:focus {
            box-shadow: 0 0 15px #0000FF;
        }
        .chat-input {
            flex: 1;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 5px;
            box-sizing: border-box;
        }
        footer {
            text-align: center;
            padding: 10px;
            margin-top: 20px;
        }
        select[id^="chart-type"], select[id^="time-frame"], select[id^="form-type"] {
            color: #0000FF;
            border-color: #0000FF;
            cursor: pointer;
        }
        select[id^="chart-type"] option,
        select[id^="time-frame"] option {
            color: black;
            background: #fff;
        }
        .admin-tools-container {
            position: fixed;
            right: 20px;
            top: 120px;
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            padding: 12px;
            z-index: 999;
            display: none;
            grid-template-columns: repeat(2, 1fr);
            grid-template-rows: repeat(6, 1fr);
            gap: 10px;
            width: 320px;
        }
        .admin-tools-container.open {
            display: grid;
        }
        .sidebar-button {
            background-color: #3B82F6;
            color: white;
            padding: 10px;
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            transition: background-color 0.3s, transform 0.1s;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .sidebar-button:hover {
            background-color: #2563EB;
        }
        .sidebar-button:active {
            transform: scale(0.95);
        }
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1002;
            justify-content: center;
            align-items: center;
        }
        .modal.open {
            display: flex;
        }
        .modal-content {
            background: white;
            border-radius: 8px;
            width: 80%;
            max-width: 900px;
            max-height: 80vh;
            overflow-y: auto;
            padding: 20px;
            position: relative;
        }
        .modal-close {
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 20px;
            cursor: pointer;
        }
        #map {
            height: 400px;
            border-radius: 8px;
            border: 1px solid #ddd;
        }
        .alert-item {
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 5px;
            cursor: pointer;
        }
        .alert-item.critical {
            background: #ffcccc;
            border: 1px solid #ff0000;
        }
        .alert-item.warning {
            background: #fff4cc;
            border: 1px solid #ff9900;
        }
        .alert-dropdown {
            position: absolute;
            top: 60px;
            right: 20px;
            width: 300px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.2);
            z-index: 1001;
            display: none;
        }
        .alert-dropdown.open {
            display: block;
        }
        .gauge {
            width: 100px;
            height: 50px;
            position: relative;
        }
        .gauge canvas {
            width: 100%;
            height: 100%;
        }
        .form-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 10px;
        }
        .form-action-button {
            background-color: #3B82F6;
            color: white;
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            transition: background-color 0.3s;
        }
        .form-action-button:hover {
            background-color: #2563EB;
        }
        .form-action-button:active {
            transform: scale(0.95);
        }
        #inspectionDetailsModal .modal-content {
            max-width: 600px;
        }
        .inspection-form label {
            font-weight: bold;
            margin-top: 10px;
            display: block;
        }
        .inspection-form p {
            margin: 5px 0;
        }
        .checklist {
            margin-top: 20px;
        }
        .checklist-item {
            display: flex;
            justify-content: space-between;
            padding: 5px 0;
        }
    </style>
</head>
<body class="bg-gray-100">
    <div class="container mx-auto p-6">
        <form class="absolute top-4 left-4" method="POST" action="/logout">
            <button type="submit" class="bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600">Logout</button>
        </form>
        <div class="absolute top-4 right-4">
            <div class="relative">
                <button id="alertBell" class="bg-gray-200 p-2 rounded-full hover:bg-gray-300">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#000000" stroke-width="2">
                        <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path>
                        <path d="M13.73 21a2 2 0 0 1-3.46 0"></path>
                    </svg>
                    <span id="alertBadge" class="absolute top-0 right-0 bg-red-500 text-white rounded-full w-5 h-5 flex items-center justify-center text-xs"></span>
                </button>
                <div id="alertDropdown" class="alert-dropdown">
                    <div id="alertList" class="p-2"></div>
                </div>
            </div>
        </div>
        <h1 class="text-3xl font-bold text-center black-bold mb-6">Admin Dashboard</h1>

        <div class="flex justify-center mb-6 items-center">
            <div class="inline-flex rounded-md shadow-sm" role="group">
                <button data-tab="overview" class="tab active px-4 py-2 text-sm font-medium text-gray-900 bg-white border border-gray-200 rounded-l-lg hover:bg-gray-100">Overview</button>
                <button data-tab="food" class="tab px-4 py-2 text-sm font-medium text-gray-900 bg-white border-t border-b border-gray-200 hover:bg-gray-100">Food Inspection</button>
                <button data-tab="residential" class="tab px-4 py-2 text-sm font-medium text-gray-900 bg-white border-t border-b border-gray-200 hover:bg-gray-100">Residential</button>
                <button data-tab="burial" class="tab px-4 py-2 text-sm font-medium text-gray-900 bg-white border-t border-b border-gray-200 hover:bg-gray-100">Burial</button>
                <button data-tab="spirit_licence" class="tab px-4 py-2 text-sm font-medium text-gray-900 bg-white border-t border-b border-gray-200 hover:bg-gray-100">Spirit Licence</button>
                <button data-tab="swimming_pool" class="tab px-4 py-2 text-sm font-medium text-gray-900 bg-white border-t border-b border-gray-200 hover:bg-gray-100">Swimming Pool</button>
                <button data-tab="small_hotels" class="tab px-4 py-2 text-sm font-medium text-gray-900 bg-white border-t border-b border-gray-200 rounded-r-lg hover:bg-gray-100">Small Hotels</button>
            </div>
            <button id="adminToolsButton" class="ml-auto px-4 py-2 text-sm font-medium text-gray-900 bg-white border border-gray-200 rounded-lg hover:bg-gray-100">Admin Tools</button>
        </div>

        <div id="overview" class="tab-content active">
            <h2 class="text-2xl font-bold mb-4 blue-bold">All Inspections</h2>
            <div class="mb-4 flex space-x-4">
                <select id="chart-type" class="p-2 border rounded blue-bold-select">
                    <option value="bar">Bar</option>
                    <option value="line">Line</option>
                </select>
                <select id="time-frame" class="p-2 border rounded blue-bold-select">
                    <option value="daily">Daily</option>
                    <option value="monthly">Monthly</option>
                    <option value="yearly">Yearly</option>
                </select>
            </div>
            <canvas id="metricsChart"></canvas>
            <div class="bg-white shadow-md rounded-lg overflow-hidden mt-6">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Form ID</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Form Type</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Inspector</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Completion Time</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                        {% for form in forms %}
                        <tr class="hover:bg-gray-50" data-form-id="{{ form[0] }}" data-form-type="{{ form[1] }}">
                            <td class="px-6 py-4 whitespace-nowrap">{{ form[0] }}</td>
                            <td class="px-6 py-4 whitespace-nowrap">{{ form[1] }}</td>
                            <td class="px-6 py-4 whitespace-nowrap">{{ form[2] or 'N/A' }}</td>
                            <td class="px-6 py-4 whitespace-nowrap">30 min</td>
                            <td class="px-6 py-4 whitespace-nowrap">{{ form[3] }}</td>
                            <td class="px-6 py-4 whitespace-nowrap">{{ form[4] or 'N/A' }}</td>
                            <td class="px-6 py-4 whitespace-nowrap">{{ 'Pass' if form[5] in ['Pass', 'Completed', 'Satisfactory'] else 'Fail' }}</td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="form-actions">
                                    <button class="form-action-button" onclick="viewForm('{{ form[0] }}', '{{ form[1] }}')">View</button>
                                    <button class="form-action-button" onclick="downloadForm('{{ form[0] }}', '{{ form[1] }}')">Download</button>
                                    <button class="form-action-button" onclick="shareForm('{{ form[0] }}', '{{ form[1] }}')">Share</button>
                                    <button class="form-action-button" onclick="printForm('{{ form[0] }}', '{{ form[1] }}')">Print</button>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        {% for tab in ['food', 'residential', 'burial', 'spirit_licence', 'swimming_pool', 'small_hotels'] %}
        <div id="{{ tab }}" class="tab-content">
            <h2 class="text-2xl font-bold mb-4 black-bold">{{ tab.replace('_', ' ').title() }} Inspections</h2>
            <div class="mb-4 flex space-x-4">
                <select id="chart-type-{{ tab }}" class="p-2 border rounded black-bold-select">
                    <option value="bar">Bar</option>
                    <option value="line">Line</option>
                </select>
                <select id="time-frame-{{ tab }}" class="p-2 border rounded black-bold-select">
                    <option value="daily">Daily</option>
                    <option value="monthly">Monthly</option>
                    <option value="yearly">Yearly</option>
                </select>
                <select id="form-type-{{ tab }}" class="p-2 border rounded black-bold-select">
                    <option value="{% if tab == 'food' %}Food Establishment{% elif tab == 'spirit_licence' %}Spirit Licence Premises{% elif tab == 'swimming_pool' %}Swimming Pool{% elif tab == 'small_hotels' %}Small Hotel{% else %}{{ tab.replace('_', ' ').title() }}{% endif %}">{{ tab.replace('_', ' ').title() }}</option>
                </select>
            </div>
            <canvas id="metricsChart-{{ tab }}"></canvas>
            <div class="bg-white shadow-md rounded-lg overflow-hidden mt-6">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Form ID</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Inspector</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Completion Time</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                        {% for form in forms %}
                        {% if form[1]|lower == tab.replace('_', ' ') or (tab == 'food' and form[1] == 'Food Establishment') or (tab == 'spirit_licence' and form[1] == 'Spirit Licence Premises') or (tab == 'swimming_pool' and form[1] == 'Swimming Pool') or (tab == 'small_hotels' and form[1] == 'Small Hotel') %}
                        <tr class="hover:bg-gray-50" data-form-id="{{ form[0] }}" data-form-type="{{ form[1] }}">
                            <td class="px-6 py-4 whitespace-nowrap">{{ form[0] }}</td>
                            <td class="px-6 py-4 whitespace-nowrap">{{ form[2] or 'N/A' }}</td>
                            <td class="px-6 py-4 whitespace-nowrap">30 min</td>
                            <td class="px-6 py-4 whitespace-nowrap">{{ form[3] }}</td>
                            <td class="px-6 py-4 whitespace-nowrap">{{ form[4] or 'N/A' }}</td>
                            <td class="px-6 py-4 whitespace-nowrap">{{ 'Pass' if form[5] in ['Pass', 'Completed', 'Satisfactory'] else 'Fail' }}</td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="form-actions">
                                    <button class="form-action-button" onclick="viewForm('{{ form[0] }}', '{{ form[1] }}')">View</button>
                                    <button class="form-action-button" onclick="downloadForm('{{ form[0] }}', '{{ form[1] }}')">Download</button>
                                    <button class="form-action-button" onclick="shareForm('{{ form[0] }}', '{{ form[1] }}')">Share</button>
                                    <button class="form-action-button" onclick="printForm('{{ form[0] }}', '{{ form[1] }}')">Print</button>
                                </div>
                            </td>
                        </tr>
                        {% endif %}
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        {% endfor %}

        <div id="inspectionDetailsModal" class="modal">
            <div class="modal-content">
                <span class="modal-close" onclick="closeModal('inspectionDetails')">√ó</span>
                <h2 class="text-2xl font-bold mb-4 black-bold">Inspection Details</h2>
                <div id="inspectionDetails"></div>
                <div class="form-actions">
                    <button class="form-action-button" onclick="downloadFormFromModal()">Download</button>
                    <button class="form-action-button" onclick="shareFormFromModal()">Share</button>
                    <button class="form-action-button" onclick="printFormFromModal()">Print</button>
                </div>
            </div>
        </div>

        <div id="active_users_modal" class="modal">
            <div class="modal-content">
                <span class="modal-close" onclick="closeModal('active_users')">√ó</span>
                <h2 class="text-2xl font-bold mb-4 black-bold">Active Users</h2>
                <div class="bg-white shadow-md rounded-lg overflow-hidden">
                    <table id="activeUsersTable" class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Username</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Role</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Last Activity</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Login Time</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Device</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="audit_log_modal" class="modal">
            <div class="modal-content">
                <span class="modal-close" onclick="closeModal('audit_log')">√ó</span>
                <h2 class="text-2xl font-bold mb-4 black-bold">Audit Log</h2>
                <div class="mb-4 flex space-x-4">
                    <input type="text" id="auditSearch" class="p-2 border rounded" placeholder="Search by user or action...">
                    <select id="auditFilter" class="p-2 border rounded black-bold-select">
                        <option value="all">All Actions</option>
                        <option value="login">Login</option>
                        <option value="logout">Logout</option>
                        <option value="inspection">Inspection</option>
                    </select>
                </div>
                <div class="bg-white shadow-md rounded-lg overflow-hidden">
                    <table id="auditLogTable" class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Timestamp</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">User</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Action</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">IP Address</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Details</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="inspector_performance_modal" class="modal">
            <div class="modal-content">
                <span class="modal-close" onclick="closeModal('inspector_performance')">√ó</span>
                <h2 class="text-2xl font-bold mb-4 black-bold">Inspector Performance</h2>
                <div class="mb-4 flex space-x-4">
                    <select id="chart-type-performance" class="p-2 border rounded black-bold-select">
                        <option value="bar">Bar</option>
                        <option value="line">Line</option>
                    </select>
                    <select id="time-frame-performance" class="p-2 border rounded black-bold-select">
                        <option value="weekly">Weekly</option>
                        <option value="monthly">Monthly</option>
                        <option value="yearly">Yearly</option>
                    </select>
                </div>
                <canvas id="performanceChart"></canvas>
                <div class="bg-white shadow-md rounded-lg overflow-hidden mt-6">
                    <table id="performanceTable" class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Inspector</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Inspections Completed</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Avg. Completion Time</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Pass Rate</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Overdue Tasks</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="alerts_modal" class="modal">
            <div class="modal-content">
                <span class="modal-close" onclick="closeModal('alerts')">√ó</span>
                <h2 class="text-2xl font-bold mb-4 black-bold">Alerts</h2>
                <div id="alertsList" class="space-y-4"></div>
            </div>
        </div>

        <div id="inspection_map_modal" class="modal">
            <div class="modal-content">
                <span class="modal-close" onclick="closeModal('inspection_map')">√ó</span>
                <h2 class="text-2xl font-bold mb-4 black-bold">Inspection Map</h2>
                <div id="map"></div>
                <div class="mb-4 flex space-x-4 mt-4">
                    <select id="map-filter" class="p-2 border rounded black-bold-select">
                        <option value="all">All Inspections</option>
                        <option value="pass">Pass</option>
                        <option value="fail">Fail</option>
                    </select>
                </div>
            </div>
        </div>

        <div id="custom_reports_modal" class="modal">
            <div class="modal-content">
                <span class="modal-close" onclick="closeModal('custom_reports')">√ó</span>
                <h2 class="text-2xl font-bold mb-4 black-bold">Custom Reports</h2>
                <div class="bg-white shadow-md rounded-lg p-6">
                    <div class="mb-4 flex space-x-4">
                        <select id="report-metric" class="p-2 border rounded black-bold-select">
                            <option value="inspections">Inspections</option>
                            <option value="user_activity">User Activity</option>
                            <option value="appointments">Appointments</option>
                        </select>
                        <select id="report-timeframe" class="p-2 border rounded black-bold-select">
                            <option value="weekly">Weekly</option>
                            <option value="monthly">Monthly</option>
                            <option value="yearly">Yearly</option>
                        </select>
                    </div>
                    <button id="generateReport" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">Generate Report</button>
                    <div id="reportOutput" class="mt-4"></div>
                </div>
            </div>
        </div>

        <div id="user_management_modal" class="modal">
            <div class="modal-content">
                <span class="modal-close" onclick="closeModal('user_management')">√ó</span>
                <h2 class="text-2xl font-bold mb-4 black-bold">User Management</h2>
                <div class="mb-4">
                    <button onclick="openAddUserModal()" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600">Add User</button>
                </div>
                <div class="bg-white shadow-md rounded-lg overflow-hidden mb-6">
                    <table id="usersTable" class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Username</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Email</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Role</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200"></tbody>
                    </table>
                </div>
                <h3 class="text-xl font-bold mb-4 black-bold">Login History</h3>
                <div class="bg-white shadow-md rounded-lg overflow-hidden">
                    <table id="loginHistoryTable" class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Email</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Username</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Login Time</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Role</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">IP Address</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="add_user_modal" class="modal">
            <div class="modal-content">
                <span class="modal-close" onclick="closeAddUserModal()">√ó</span>
                <h2 class="text-2xl font-bold mb-4 black-bold">Add User</h2>
                <div class="space-y-4">
                    <input type="text" id="newUsername" class="p-2 border rounded w-full" placeholder="Username" required>
                    <input type="email" id="newUserEmail" class="p-2 border rounded w-full" placeholder="Email" required>
                    <input type="password" id="newUserPassword" class="p-2 border rounded w-full" placeholder="Password" required>
                    <select id="newUserRole" class="p-2 border rounded black-bold-select w-full">
                        <option value="Admin">Admin</option>
                        <option value="Inspector">Inspector</option>
                        <option value="Medical Officer">Medical Officer</option>
                    </select>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Permissions</label>
                        <div class="mt-2 space-y-2">
                            <div>
                                <input type="checkbox" id="permMarkOne" value="Mark One" class="mr-2">
                                <label for="permMarkOne">Mark One</label>
                            </div>
                            <div>
                                <input type="checkbox" id="permMarkTwo" value="Mark Two" class="mr-2">
                                <label for="permMarkTwo">Mark Two</label>
                            </div>
                        </div>
                    </div>
                    <button onclick="addUser()" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">Add User</button>
                </div>
            </div>
        </div>

        <div id="edit_user_modal" class="modal">
            <div class="modal-content">
                <span class="modal-close" onclick="closeEditUserModal()">√ó</span>
                <h2 class="text-2xl font-bold mb-4 black-bold">Edit User</h2>
                <div class="space-y-4">
                    <input type="hidden" id="editUserId">
                    <input type="text" id="editUsername" class="p-2 border rounded w-full" readonly>
                    <input type="email" id="editUserEmail" class="p-2 border rounded w-full" placeholder="Email">
                    <select id="editUserRole" class="p-2 border rounded black-bold-select w-full">
                        <option value="Admin">Admin</option>
                        <option value="Inspector">Inspector</option>
                        <option value="Medical Officer">Medical Officer</option>
                    </select>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Permissions</label>
                        <div class="mt-2 space-y-2">
                            <div>
                                <input type="checkbox" id="editPermMarkOne" value="Mark One" class="mr-2">
                                <label for="editPermMarkOne">Mark One</label>
                            </div>
                            <div>
                                <input type="checkbox" id="editPermMarkTwo" value="Mark Two" class="mr-2">
                                <label for="editPermMarkTwo">Mark Two</label>
                            </div>
                        </div>
                    </div>
                    <button onclick="saveUser()" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">Save Changes</button>
                </div>
            </div>
        </div>

        <div id="system_health_modal" class="modal">
            <div class="modal-content">
                <span class="modal-close" onclick="closeModal('system_health')">√ó</span>
                <h2 class="text-2xl font-bold mb-4 black-bold">System Health</h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="bg-white shadow-md rounded-lg p-4">
                        <h3 class="text-lg font-bold black-bold">Server Uptime</h3>
                        <div class="gauge" id="uptimeGauge"></div>
                        <p id="uptimeValue" class="text-center"></p>
                    </div>
                    <div class="bg-white shadow-md rounded-lg p-4">
                        <h3 class="text-lg font-bold black-bold">Database Response</h3>
                        <div class="gauge" id="dbGauge"></div>
                        <p id="dbValue" class="text-center"></p>
                    </div>
                    <div class="bg-white shadow-md rounded-lg p-4">
                        <h3 class="text-lg font-bold black-bold">Error Rate</h3>
                        <div class="gauge" id="errorGauge"></div>
                        <p id="errorValue" class="text-center"></p>
                    </div>
                </div>
                <canvas id="healthChart" class="mt-6"></canvas>
            </div>
        </div>

        <div id="task_assignment_modal" class="modal">
            <div class="modal-content">
                <span class="modal-close" onclick="closeModal('task_assignment')">√ó</span>
                <h2 class="text-2xl font-bold mb-4 black-bold">Task Assignment</h2>
                <div class="bg-white shadow-md rounded-lg p-6 mb-6">
                    <h3 class="text-lg font-bold black-bold mb-4">Assign New Task</h3>
                    <div class="space-y-4">
                        <input type="text" id="taskTitle" class="p-2 border rounded w-full" placeholder="Task Title">
                        <select id="taskAssignee" class="p-2 border rounded black-bold-select w-full">
                            <option value="">Select Inspector</option>
                        </select>
                        <input type="date" id="taskDueDate" class="p-2 border rounded w-full">
                        <textarea id="taskDetails" class="p-2 border rounded w-full" placeholder="Task Details"></textarea>
                        <button id="assignTask" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">Assign Task</button>
                    </div>
                </div>
                <div class="bg-white shadow-md rounded-lg overflow-hidden">
                    <table id="tasksTable" class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Task ID</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Title</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Assignee</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Due Date</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="security_metrics_modal" class="modal">
            <div class="modal-content">
                <span class="modal-close" onclick="closeModal('security_metrics')">√ó</span>
                <h2 class="text-2xl font-bold mb-4 black-bold">Security Metrics</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="bg-white shadow-md rounded-lg p-4">
                        <h3 class="text-lg font-bold black-bold">MFA Adoption</h3>
                        <canvas id="mfaChart"></canvas>
                    </div>
                    <div class="bg-white shadow-md rounded-lg p-4">
                        <h3 class="text-lg font-bold black-bold">Security Events</h3>
                        <canvas id="securityEventsChart"></canvas>
                    </div>
                </div>
                <div class="bg-white shadow-md rounded-lg overflow-hidden mt-6">
                    <table id="securityEventsTable" class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Timestamp</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Event Type</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">User</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Details</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="admin-tools-container" class="admin-tools-container">
    <div class="sidebar-button" data-modal="active_users">Active Users</div>
    <div class="sidebar-button" data-modal="audit_log">Audit Log</div>
    <div class="sidebar-button" data-modal="inspector_performance">Inspector Performance</div>
    <div class="sidebar-button" data-modal="alerts">Alerts</div>
    <div class="sidebar-button" data-modal="inspection_map">Inspection Map</div>
    <div class="sidebar-button" data-modal="custom_reports">Custom Reports</div>
    <div class="sidebar-button" data-modal="user_management">User Management</div>
    <div class="sidebar-button" data-modal="system_health">System Health</div>
    <div class="sidebar-button" data-modal="task_assignment">Task Assignment</div>
    <div class="sidebar-button" data-modal="security_metrics">Security Metrics</div>
    <div class="sidebar-button" onclick="window.location.href='/admin/forms'" style="background-color: #17a2b8;">
        üìù Manage Forms
    </div>
            <!-- NEW: Parish Leaderboard Button -->
    <div class="sidebar-button" onclick="window.open('/parish_leaderboard', '_blank')" style="background-color: #009b3a;">üèÜ Parish Rankings</div>
</div>

        <div class="chat-container">
            <div class="chat-icon" onclick="toggleChat()">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
                </svg>
                <span id="chatIconBadge" class="chat-icon-badge"></span>
            </div>
            <div class="chat-window" id="chatWindow">
                <div class="chat-header">
                    <span>Messages</span>
                    <span class="add-contact" onclick="toggleContactList(true)">+</span>
                </div>
                <div class="chat-body" id="chatBody">
                    <div class="message-area" id="messageArea"></div>
                    <div class="chat-tab-container"></div>
                </div>
                <div class="chat-footer">
                    <input type="text" class="chat-input" id="chatInput" placeholder="Type a message..." disabled>
                    <button onclick="sendMessage()">Send</button>
                </div>
            </div>
            <div class="contact-list" id="contactList"></div>
        </div>
    </div>

    <footer>
        <a href="https://www.linkedin.com" target="_blank" class="black-bold">Connect on LinkedIn</a>
    </footer>

    <script>
        const tabs = document.querySelectorAll('.tab');
        const tabContents = document.querySelectorAll('.tab-content');
        const adminToolsButton = document.getElementById('adminToolsButton');
        const adminToolsContainer = document.getElementById('admin-tools-container');
        const sidebarButtons = document.querySelectorAll('.sidebar-button');
        const charts = {};
        let currentFormId = null;
        let currentFormType = null;

        tabs.forEach(tab => {
            tab.addEventListener('click', () => {
                tabs.forEach(t => t.classList.remove('active'));
                tabContents.forEach(content => content.classList.remove('active'));
                tab.classList.add('active');
                document.querySelector(`#${tab.dataset.tab}`).classList.add('active');
                loadMetrics(tab.dataset.tab);
            });
        });

        adminToolsButton.addEventListener('click', (e) => {
            e.stopPropagation();
            adminToolsContainer.classList.toggle('open');
        });

        document.addEventListener('click', (e) => {
            if (!adminToolsContainer.contains(e.target) && e.target !== adminToolsButton && !e.target.closest('.sidebar-button')) {
                adminToolsContainer.classList.remove('open');
            }
        });

        sidebarButtons.forEach(button => {
            button.addEventListener('click', (e) => {
                e.stopPropagation();
                adminToolsContainer.classList.remove('open');
                const modalId = `${button.dataset.modal}_modal`;
                openModal(button.dataset.modal);
            });
        });

        function openModal(feature) {
            const modal = document.getElementById(`${feature}_modal`);
            modal.classList.add('open');
            switch (feature) {
                case 'active_users':
                    loadActiveUsers();
                    break;
                case 'audit_log':
                    loadAuditLog();
                    break;
                case 'inspector_performance':
                    loadInspectorPerformance();
                    break;
                case 'alerts':
                    loadAlerts();
                    break;
                case 'inspection_map':
                    loadInspectionMap();
                    break;
                case 'custom_reports':
                    initializeReports();
                    break;
                case 'user_management':
                    loadUsers();
                    break;
                case 'system_health':
                    loadSystemHealth();
                    break;
                case 'task_assignment':
                    loadTasks();
                    break;
                case 'security_metrics':
                    loadSecurityMetrics();
                    break;
                case 'inspectionDetails':
                    loadInspectionDetails(currentFormId, currentFormType);
                    break;
            }
        }

        function closeModal(feature) {
            const modal = document.getElementById(`${feature}_modal`);
            modal.classList.remove('open');
            if (charts[`${feature}_chart`]) {
                charts[`${feature}_chart`].destroy();
                delete charts[`${feature}_chart`];
            }
        }

        async function loadMetrics(tab) {
            const formTypeSelect = document.querySelector(`#form-type${tab !== 'overview' ? '-' + tab : ''}`);
            const formType = formTypeSelect ? formTypeSelect.value : (tab === 'overview' ? 'all' :
                     tab === 'food' ? 'Food Establishment' :
                     tab === 'spirit_licence' ? 'Spirit Licence Premises' :
                     tab === 'swimming_pool' ? 'Swimming Pool' :
                     tab === 'small_hotels' ? 'Small Hotel' :
                     tab === 'residential' ? 'Residential' :
                     tab === 'burial' ? 'Burial' :
                     tab.charAt(0).toUpperCase() + tab.slice(1));
            const chartTypeSelect = document.querySelector(`#chart-type${tab !== 'overview' ? '-' + tab : ''}`);
            const timeFrameSelect = document.querySelector(`#time-frame${tab !== 'overview' ? '-' + tab : ''}`);
            const chartId = `metricsChart${tab !== 'overview' ? '-' + tab : ''}`;
            const canvas = document.getElementById(chartId);
            if (!canvas) {
                console.error(`Canvas not found: ${chartId}`);
                return;
            }
            const ctx = canvas.getContext('2d');

            if (charts[chartId]) {
                charts[chartId].destroy();
            }

            try {
                const response = await fetch(`/admin_metrics?form_type=${encodeURIComponent(formType)}&time_frame=${timeFrameSelect.value}&t=${Date.now()}`);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                const data = await response.json();
                if (data.error) throw new Error(data.error);

                const formattedDates = data.dates.map(date => {
                    const d = new Date(date);
                    return isNaN(d) ? date : d.toLocaleDateString('en-US', {
                        month: 'short',
                        day: '2-digit',
                        year: 'numeric'
                    });
                });

                charts[chartId] = new Chart(ctx, {
                    type: chartTypeSelect.value,
                    data: {
                        labels: formattedDates,
                        datasets: [
                            {
                                label: 'Pass',
                                data: data.pass,
                                backgroundColor: '#006400',
                                borderColor: '#006400',
                                borderWidth: 1
                            },
                            {
                                label: 'Fail',
                                data: data.fail,
                                backgroundColor: '#FF0000',
                                borderColor: '#FF0000',
                                borderWidth: 1
                            }
                        ]
                    },
                    options: {
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: { color: '#000000', font: { family: 'Arial', size: 12 } },
                                grid: { color: 'rgba(255, 255, 255, 0.1)' }
                            },
                            x: {
                                ticks: { color: '#000000', font: { family: 'Arial', size: 12 } },
                                grid: { color: 'rgba(255, 255, 255, 0.1)' }
                            }
                        },
                        plugins: {
                            legend: { labels: { color: '#000000' } }
                        }
                    }
                });
            } catch (error) {
                console.error(`Error loading metrics for ${tab}:`, error);
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.fillStyle = '#ffffff';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                ctx.fillStyle = '#ff0000';
                ctx.font = '16px Arial';
                ctx.fillText('Error loading chart', 10, 50);
            }
        }

        document.querySelectorAll('#form-type-food, #form-type-residential, #form-type-burial, #form-type-spirit_licence, #form-type-swimming_pool, #form-type-small_hotels').forEach(select => {
            select.addEventListener('change', () => loadMetrics(select.id.split('-')[1]));
        });

        async function viewForm(formId, formType) {
            let endpoint;
            switch (formType) {
                case 'Food Establishment':
                    endpoint = `/inspection/${formId}`;
                    break;
                case 'Residential':
                    endpoint = `/residential/inspection/${formId}`;
                    break;
                case 'Burial':
                    endpoint = `/burial/inspection/${formId}`;
                    break;
                case 'Spirit Licence Premises':
                    endpoint = `/spirit_licence/inspection/${formId}`;
                    break;
                case 'Swimming Pool':
                    endpoint = `/swimming_pool/inspection/${formId}`;
                    break;
                case 'Small Hotel':
                    endpoint = `/view_small_hotels/${formId}`;
                    break;
                default:
                    endpoint = `/inspection/${formId}`;
            }
            window.location.href = endpoint;
        }

        async function loadInspectionDetails(formId, formType) {
            const detailsDiv = document.getElementById('inspectionDetails');
            detailsDiv.innerHTML = '<p>Loading...</p>';
            try {
                let endpoint;
                switch (formType) {
                    case 'Food Establishment':
                        endpoint = `/food/inspection/${formId}`;
                        break;
                    case 'Residential':
                        endpoint = `/residential/inspection/${formId}`;
                        break;
                    case 'Burial':
                        endpoint = `/burial/inspection/${formId}`;
                        break;
                    case 'Spirit Licence Premises':
                        endpoint = `/spirit_licence/inspection/${formId}`;
                        break;
                    case 'Swimming Pool':
                        endpoint = `/swimming_pool/inspection/${formId}`;
                        break;
                    case 'Small Hotel':
                        endpoint = `/small_hotels/inspection/${formId}`;
                        break;
                    default:
                        endpoint = `/inspection/${formId}`;
                }
                const response = await fetch(endpoint);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                const form = await response.json();

                let html = '<div class="inspection-form">';

                switch (formType) {
                    case 'Food Establishment':
                    case 'Spirit Licence Premises':
                    case 'Swimming Pool':
                    case 'Small Hotel':
                        html += `
                            <div class="form-group">
                                <label>Establishment Name</label>
                                <p>${form.establishment_name || 'N/A'}</p>
                            </div>
                            <div class="form-group">
                                <label>Address</label>
                                <p>${form.address || 'N/A'}</p>
                            </div>
                            <div class="form-group">
                                <label>License #</label>
                                <p>${form.license_no || 'N/A'}</p>
                            </div>
                            <div class="form-group">
                                <label>Owner</label>
                                <p>${form.owner || 'N/A'}</p>
                            </div>
                            <div class="form-group">
                                <label>Number of Employees</label>
                                <p>${form.no_of_employees || 'N/A'}</p>
                            </div>
                            <div class="form-group">
                                <label>Purpose of Visit</label>
                                <p>${form.purpose_of_visit || 'N/A'}</p>
                            </div>
                            <div class="form-group">
                                <label>Action</label>
                                <p>${form.action || 'N/A'}</p>
                            </div>
                            <div class="form-group">
                                <label>Inspector Name</label>
                                <p>${form.inspector_name || 'N/A'}</p>
                            </div>
                            <div class="form-group">
                                <label>Inspector Code</label>
                                <p>${form.inspector_code || 'N/A'}</p>
                            </div>
                            <div class="form-group">
                                <label>Inspection Date</label>
                                <p>${form.inspection_date || 'N/A'}</p>
                            </div>
                            <div class="form-group">
                                <label>Inspection Time</label>
                                <p>${form.inspection_time || 'N/A'}</p>
                            </div>
                            <div class="form-group">
                                <label>Type of Establishment</label>
                                <p>${form.type_of_establishment || 'N/A'}</p>
                            </div>
                            <div class="form-group">
                                <label>Physical Location</label>
                                <p>${form.physical_location || 'N/A'}</p>
                            </div>
                            <div class="form-group">
                                <label>Result</label>
                                <p>${form.result || 'N/A'}</p>
                            </div>
                            <div class="form-group">
                                <label>Critical Score</label>
                                <p>${form.critical_score || 'N/A'}</p>
                            </div>
                            <div class="form-group">
                                <label>Overall Score</label>
                                <p>${form.overall_score || 'N/A'}</p>
                            </div>
                            ${formType === 'Food Establishment' ? `
                            <div class="form-group">
                                <label>Food Inspected (kg)</label>
                                <p>${form.food_inspected || 'N/A'}</p>
                            </div>
                            <div class="form-group">
                                <label>Food Condemned (kg)</label>
                                <p>${form.food_condemned || 'N/A'}</p>
                            </div>
                            ` : ''}
                            <div class="form-group">
                                <label>Comments</label>
                                <p>${form.comments || 'N/A'}</p>
                            </div>
                            <div class="form-group">
                                <label>Inspector Signature</label>
                                <p>${form.inspector_signature || 'N/A'}</p>
                            </div>
                            <div class="form-group">
                                <label>Received By</label>
                                <p>${form.received_by || 'N/A'}</p>
                            </div>
                            <div class="form-group">
                                <label>Manager Signature</label>
                                <p>${form.manager_signature || 'N/A'}</p>
                            </div>
                            <div class="form-group">
                                <label>Manager Date</label>
                                <p>${form.manager_date || 'N/A'}</p>
                            </div>
                            <div class="checklist">
                                <h3>Checklist Scores</h3>
                                ${Object.entries(form.scores || {}).map(([item, score]) => `
                                    <div class="checklist-item">
                                        <span>Item ${item}</span>
                                        <span>${score || 'N/A'}</span>
                                    </div>
                                `).join('')}
                            </div>
                        `;
                        break;
                    case 'Residential':
                        html += `
                            <div class="form-group">
                                <label>Premises Name</label>
                                <p>${form.premises_name || 'N/A'}</p>
                            </div>
                            <div class="form-group">
                                <label>Owner/Agent/Occupier</label>
                                <p>${form.owner || 'N/A'}</p>
                            </div>
                            <div class="form-group">
                                <label>Address</label>
                                <p>${form.address || 'N/A'}</p>
                            </div>
                            <div class="form-group">
                                <label>Inspector Name</label>
                                <p>${form.inspector_name || 'N/A'}</p>
                            </div>
                            <div class="form-group">
                                <label>Inspector Code</label>
                                <p>${form.inspector_code || 'N/A'}</p>
                            </div>
                            <div class="form-group">
                                <label>Inspection Date</label>
                                <p>${form.inspection_date || 'N/A'}</p>
                            </div>
                            <div class="form-group">
                                <label>Treatment Facility</label>
                                <p>${form.treatment_facility || 'N/A'}</p>
                            </div>
                            <div class="form-group">
                                <label>Vector</label>
                                <p>${form.vector || 'N/A'}</p>
                            </div>
                            <div class="form-group">
                                <label>Result</label>
                                <p>${form.result || 'N/A'}</p>
                            </div>
                            <div class="form-group">
                                <label>Onsite System</label>
                                <p>${form.onsite_system || 'N/A'}</p>
                            </div>
                            <div class="form-group">
                                <label>Building Construction Type</label>
                                <p>${form.building_construction_type || 'N/A'}</p>
                            </div>
                            <div class="form-group">
                                <label>Purpose of Visit</label>
                                <p>${form.purpose_of_visit || 'N/A'}</p>
                            </div>
                            <div class="form-group">
                                <label>Action</label>
                                <p>${form.action || 'N/A'}</p>
                            </div>
                            <div class="form-group">
                                <label>Number of Bedrooms</label>
                                <p>${form.no_of_bedrooms || 'N/A'}</p>
                            </div>
                            <div class="form-group">
                                <label>Total Population</label>
                                <p>${form.total_population || 'N/A'}</p>
                            </div>
                            <div class="form-group">
                                <label>Critical Score</label>
                                <p>${form.critical_score || 'N/A'}</p>
                            </div>
                            <div class="form-group">
                                <label>Overall Score</label>
                                <p>${form.overall_score || 'N/A'}</p>
                            </div>
                            <div class="form-group">
                                <label>Comments</label>
                                <p>${form.comments || 'N/A'}</p>
                            </div>
                            <div class="form-group">
                                <label>Inspector Signature</label>
                                <p>${form.inspector_signature || 'N/A'}</p>
                            </div>
                            <div class="form-group">
                                <label>Received By</label>
                                <p>${form.received_by || 'N/A'}</p>
                            </div>
                            <div class="checklist">
                                <h3>Checklist Scores</h3>
                                ${Object.entries(form.checklist_scores || {}).map(([item, score]) => `
                                    <div class="checklist-item">
                                        <span>Item ${item}</span>
                                        <span>${score || 'N/A'}</span>
                                    </div>
                                `).join('')}
                            </div>
                        `;
                        break;
                    case 'Burial':
                        html += `
                            <div class="form-group">
                                <label>Applicant Name</label>
                                <p>${form.applicant_name || 'N/A'}</p>
                            </div>
                            <div class="form-group">
                                <label>Deceased Name</label>
                                <p>${form.deceased_name || 'N/A'}</p>
                            </div>
                            <div class="form-group">
                                <label>Inspection Date</label>
                                <p>${form.inspection_date || 'N/A'}</p>
                            </div>
                            <div class="form-group">
                                <label>Burial Location</label>
                                <p>${form.burial_location || 'N/A'}</p>
                            </div>
                            <div class="form-group">
                                <label>Site Description</label>
                                <p>${form.site_description || 'N/A'}</p>
                            </div>
                            <div class="form-group">
                                <label>Proximity to Water Source</label>
                                <p>${form.proximity_water_source || 'N/A'}</p>
                            </div>
                            <div class="form-group">
                                <label>Proximity to Perimeter Boundaries</label>
                                <p>${form.proximity_perimeter_boundaries || 'N/A'}</p>
                            </div>
                            <div class="form-group">
                                <label>Proximity to Road/Pathway</label>
                                <p>${form.proximity_road_pathway || 'N/A'}</p>
                            </div>
                            <div class="form-group">
                                <label>Proximity to Trees</label>
                                <p>${form.proximity_trees || 'N/A'}</p>
                            </div>
                            <div class="form-group">
                                <label>Proximity to Houses/Buildings</label>
                                <p>${form.proximity_houses_buildings || 'N/A'}</p>
                            </div>
                            <div class="form-group">
                                <label>Proposed Grave Type</label>
                                <p>${form.proposed_grave_type || 'N/A'}</p>
                            </div>
                            <div class="form-group">
                                <label>General Remarks</label>
                                <p>${form.general_remarks || 'N/A'}</p>
                            </div>
                            <div class="form-group">
                                <label>Inspector Signature</label>
                                <p>${form.inspector_signature || 'N/A'}</p>
                            </div>
                            <div class="form-group">
                                <label>Received By</label>
                                <p>${form.received_by || 'N/A'}</p>
                            </div>
                        `;
                        break;
                    default:
                        html += '<p>Form type not supported</p>';
                }
                html += '</div>';
                detailsDiv.innerHTML = html;
            } catch (error) {
                console.error(`Error loading form details for ${formId}:`, error);
                detailsDiv.innerHTML = '<p>Error loading form details</p>';
            }
        }

        async function downloadForm(formId, formType) {
            try {
                let endpoint;
                switch (formType) {
                    case 'Food Establishment':
                        endpoint = `/download_inspection_pdf/${formId}`;
                        break;
                    case 'Residential':
                        endpoint = `/download_residential_pdf/${formId}`;
                        break;
                    case 'Burial':
                        endpoint = `/download_burial_pdf/${formId}`;
                        break;
                    case 'Spirit Licence Premises':
                        endpoint = `/download_inspection_pdf/${formId}`;
                        break;
                    case 'Swimming Pool':
                        endpoint = `/download_inspection_pdf/${formId}`;
                        break;
                    case 'Small Hotel':
                        endpoint = `/download_inspection_pdf/${formId}`;
                        break;
                    default:
                        throw new Error(`Unknown form type: ${formType}`);
                }
                const response = await fetch(endpoint, {
                    method: 'GET',
                    headers: { 'Accept': 'application/pdf' }
                });
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`HTTP ${response.status}: ${errorText}`);
                }
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${formType.toLowerCase().replace(/\s/g, '_')}_form_${formId}.pdf`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);
            } catch (error) {
                console.error(`Error downloading form ${formId}:`, error);
                alert(`Failed to download form: ${error.message}`);
            }
        }

        async function downloadFormFromModal() {
            if (!currentFormId || !currentFormType) {
                alert('No form selected');
                return;
            }
            await downloadForm(currentFormId, currentFormType);
        }

        async function shareForm(formId, formType) {
            try {
                let endpoint;
                switch (formType) {
                    case 'Food Establishment':
                        endpoint = `/food/inspection/${formId}/share`;
                        break;
                    case 'Residential':
                        endpoint = `/residential/inspection/${formId}/share`;
                        break;
                    case 'Burial':
                        endpoint = `/burial/inspection/${formId}/share`;
                        break;
                    case 'Spirit Licence Premises':
                        endpoint = `/spirit_licence/inspection/${formId}/share`;
                        break;
                    case 'Swimming Pool':
                        endpoint = `/swimming_pool/inspection/${formId}/share`;
                        break;
                    case 'Small Hotel':
                        endpoint = `/small_hotels/inspection/${formId}/share`;
                        break;
                    default:
                        endpoint = `/inspection/${formId}/share`;
                }
                const response = await fetch(endpoint);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                const { url } = await response.json();
                if (navigator.share) {
                    await navigator.share({
                        title: `Inspection Form ${formId}`,
                        url: url
                    });
                } else {
                    prompt('Copy this link to share:', url);
                }
            } catch (error) {
                console.error(`Error sharing form ${formId}:`, error);
                alert('Failed to share form');
            }
        }

        async function shareFormFromModal() {
            if (!currentFormId || !currentFormType) {
                alert('No form selected');
                return;
            }
            await shareForm(currentFormId, currentFormType);
        }

        async function printForm(formId, formType) {
            try {
                let endpoint;
                switch (formType) {
                    case 'Food Establishment':
                        endpoint = `/food/inspection/${formId}/print`;
                        break;
                    case 'Residential':
                        endpoint = `/residential/inspection/${formId}/print`;
                        break;
                    case 'Burial':
                        endpoint = `/burial/inspection/${formId}/print`;
                        break;
                    case 'Spirit Licence Premises':
                        endpoint = `/spirit_licence/inspection/${formId}/print`;
                        break;
                    case 'Swimming Pool':
                        endpoint = `/swimming_pool/inspection/${formId}/print`;
                        break;
                    case 'Small Hotel':
                        endpoint = `/small_hotels/inspection/${formId}/print`;
                        break;
                    default:
                        endpoint = `/inspection/${formId}/print`;
                }
                const response = await fetch(endpoint);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const iframe = document.createElement('iframe');
                iframe.style.display = 'none';
                iframe.src = url;
                document.body.appendChild(iframe);
                iframe.contentWindow.print();
                setTimeout(() => {
                    document.body.removeChild(iframe);
                    window.URL.revokeObjectURL(url);
                }, 1000);
            } catch (error) {
                console.error(`Error printing form ${formId}:`, error);
                alert('Failed to print form');
            }
        }

        async function printFormFromModal() {
            if (!currentFormId || !currentFormType) {
                alert('No form selected');
                return;
            }
            await printForm(currentFormId, currentFormType);
        }

        async function loadActiveUsers() {
            const tbody = document.querySelector('#activeUsersTable tbody');
            tbody.innerHTML = '';
            try {
                const users = [
                    { username: 'admin1', role: 'Admin', last_activity: 'Viewing Inspections', login_time: new Date().toLocaleString(), device: 'Desktop' },
                    { username: 'inspector2', role: 'Inspector', last_activity: 'Submitting Form', login_time: new Date(Date.now() - 3600000).toLocaleString(), device: 'Mobile' }
                ];
                users.forEach(user => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap">${user.username}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${user.role}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${user.last_activity}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${user.login_time}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${user.device}</td>
                    `;
                    tbody.appendChild(row);
                });
            } catch (error) {
                console.error('Error loading active users:', error);
                tbody.innerHTML = '<tr><td colspan="5" class="px-6 py-4 text-center">Error loading data</td></tr>';
            }
        }

        async function loadAuditLog() {
        const tbody = document.querySelector('#auditLogTable tbody');
        tbody.innerHTML = '';
        const search = document.getElementById('auditSearch').value.toLowerCase();
        const filter = document.getElementById('auditFilter').value;
        try {
            const response = await fetch('/api/admin/audit_log');
            const logs = await response.json();
            logs.filter(log => (filter === 'all' || log.action.toLowerCase() === filter) &&
                      (log.user.toLowerCase().includes(search) || log.action.toLowerCase().includes(search)))
                .forEach(log => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap">${log.timestamp}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${log.user}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${log.action}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${log.ip_address}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${log.details}</td>
                    `;
                    tbody.appendChild(row);
                });
        } catch (error) {
            console.error('Error loading audit log:', error);
            tbody.innerHTML = '<tr><td colspan="5" class="px-6 py-4 text-center">Error loading data</td></tr>';
        }
    }

    async function loadInspectorPerformance() {
        const tbody = document.querySelector('#performanceTable tbody');
        tbody.innerHTML = '';
        const chartTypeSelect = document.getElementById('chart-type-performance');
        const timeFrameSelect = document.getElementById('time-frame-performance');
        const ctx = document.getElementById('performanceChart').getContext('2d');

        if (charts['performanceChart']) {
            charts['performanceChart'].destroy();
        }

        try {
            const response = await fetch(`/api/admin/inspector_performance?time_frame=${timeFrameSelect.value}`);
            const data = await response.json();
            data.inspectors.forEach(inspector => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap">${inspector.name}</td>
                    <td class="px-6 py-4 whitespace-nowrap">${inspector.completed}</td>
                    <td class="px-6 py-4 whitespace-nowrap">${inspector.avg_time}</td>
                    <td class="px-6 py-4 whitespace-nowrap">${inspector.pass_rate}%</td>
                    <td class="px-6 py-4 whitespace-nowrap">${inspector.overdue}</td>
                `;
                tbody.appendChild(row);
            });

            charts['performanceChart'] = new Chart(ctx, {
                type: chartTypeSelect.value,
                data: {
                    labels: data.inspectors.map(i => i.name),
                    datasets: [
                        {
                            label: 'Inspections Completed',
                            data: data.inspectors.map(i => i.completed),
                            backgroundColor: '#006400',
                            borderColor: '#006400',
                            borderWidth: 1
                        },
                        {
                            label: 'Pass Rate (%)',
                            data: data.inspectors.map(i => i.pass_rate),
                            backgroundColor: '#0000FF',
                            borderColor: '#0000FF',
                            borderWidth: 1
                        }
                    ]
                },
                options: {
                    scales: {
                        y: { beginAtZero: true, ticks: { color: '#000000' } },
                        x: { ticks: { color: '#000000' } }
                    },
                    plugins: {
                        legend: { labels: { color: '#000000' } }
                    }
                }
            });
        } catch (error) {
            console.error('Error loading inspector performance:', error);
            tbody.innerHTML = '<tr><td colspan="5" class="px-6 py-4 text-center">Error loading data</td></tr>';
        }
    }

    async function loadAlerts() {
        const alertsList = document.getElementById('alertsList');
        alertsList.innerHTML = '';
        try {
            const response = await fetch('/api/admin/alerts');
            const alerts = await response.json();
            alerts.forEach(alert => {
                const div = document.createElement('div');
                div.className = `alert-item ${alert.severity}`;
                div.innerHTML = `
                    <p><strong>${alert.title}</strong></p>
                    <p>${alert.description}</p>
                    <p class="text-sm text-gray-500">${new Date(alert.timestamp).toLocaleString()}</p>
                `;
                alertsList.appendChild(div);
            });
            updateAlertBadge(alerts.length);
        } catch (error) {
            console.error('Error loading alerts:', error);
            alertsList.innerHTML = '<p>Error loading alerts</p>';
        }
    }

    async function loadInspectionMap() {
        const mapFilter = document.getElementById('map-filter');
        const map = L.map('map').setView([51.505, -0.09], 13);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>'
        }).addTo(map);

        try {
            const response = await fetch(`/api/admin/inspection_locations?filter=${mapFilter.value}`);
            const locations = await response.json();
            locations.forEach(loc => {
                if (loc.latitude && loc.longitude) {
                    const marker = L.marker([loc.latitude, loc.longitude]).addTo(map);
                    marker.bindPopup(`
                        <b>${loc.form_type}</b><br>
                        ID: ${loc.form_id}<br>
                        Status: ${loc.status}<br>
                        Date: ${loc.date}
                    `);
                }
            });
        } catch (error) {
            console.error('Error loading inspection locations:', error);
        }

        mapFilter.addEventListener('change', () => loadInspectionMap());
    }

    async function initializeReports() {
        const generateButton = document.getElementById('generateReport');
        const reportOutput = document.getElementById('reportOutput');
        generateButton.addEventListener('click', async () => {
            const metric = document.getElementById('report-metric').value;
            const timeframe = document.getElementById('report-timeframe').value;
            try {
                const response = await fetch(`/api/admin/reports?metric=${metric}&timeframe=${timeframe}`);
                const report = await response.json();
                reportOutput.innerHTML = `
                    <h3 class="text-lg font-bold">${metric} Report (${timeframe})</h3>
                    <p>${report.summary}</p>
                    <table class="min-w-full divide-y divide-gray-200 mt-4">
                        <thead class="bg-gray-50">
                            <tr>
                                ${report.headers.map(header => `<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">${header}</th>`).join('')}
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            ${report.data.map(row => `
                                <tr>
                                    ${row.map(cell => `<td class="px-6 py-4 whitespace-nowrap">${cell}</td>`).join('')}
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
            } catch (error) {
                console.error('Error generating report:', error);
                reportOutput.innerHTML = '<p>Error generating report</p>';
            }
        });
    }

    async function loadUsers() {
        try {
            const [usersResponse, historyResponse] = await Promise.all([
                fetch('/api/admin/users'),
                fetch('/api/admin/login_history')
            ]);

            const users = await usersResponse.json();
            const history = await historyResponse.json();

            // Populate users table
            const usersTable = document.querySelector('#usersTable tbody');
            usersTable.innerHTML = '';
            users.forEach(user => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap">${user.username}</td>
                    <td class="px-6 py-4 whitespace-nowrap">${user.email}</td>
                    <td class="px-6 py-4 whitespace-nowrap">${user.role}</td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="px-2 py-1 text-xs rounded ${user.is_flagged ? 'bg-red-100 text-red-800' : 'bg-green-100 text-green-800'}">
                            ${user.is_flagged ? 'Flagged' : 'Active'}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <button class="form-action-button mr-2" onclick="editUser(${user.id})">Edit</button>
                        <button class="form-action-button ${user.is_flagged ? 'bg-green-500' : 'bg-yellow-500'} mr-2" onclick="toggleFlag(${user.id}, ${!user.is_flagged})">
                            ${user.is_flagged ? 'Unflag' : 'Flag'}
                        </button>
                        ${user.role !== 'admin' ? `<button class="form-action-button bg-red-500" onclick="deleteUser(${user.id})">Delete</button>` : ''}
                    </td>
                `;
                usersTable.appendChild(row);
            });

            // Populate login history table
            const historyTable = document.querySelector('#loginHistoryTable tbody');
            historyTable.innerHTML = '';
            history.forEach(login => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap">${login.email}</td>
                    <td class="px-6 py-4 whitespace-nowrap">${login.username}</td>
                    <td class="px-6 py-4 whitespace-nowrap">${login.login_time}</td>
                    <td class="px-6 py-4 whitespace-nowrap">${login.role}</td>
                    <td class="px-6 py-4 whitespace-nowrap">${login.ip_address}</td>
                `;
                historyTable.appendChild(row);
            });
        } catch (error) {
            console.error('Error loading users:', error);
        }
    }

    async function addUser() {
        const username = document.getElementById('newUsername').value.trim();
        const email = document.getElementById('newUserEmail').value.trim();
        const password = document.getElementById('newUserPassword').value.trim();
        const role = document.getElementById('newUserRole').value;

        if (!username || !email || !password || !role) {
            alert('All fields are required');
            return;
        }

        try {
            const response = await fetch('/api/admin/users', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username, email, password, role })
            });

            const result = await response.json();
            if (result.success) {
                closeAddUserModal();
                loadUsers();
                alert('User added successfully');
            } else {
                alert(result.error || 'Failed to add user');
            }
        } catch (error) {
            console.error('Error adding user:', error);
            alert('Failed to add user');
        }
    }

    async function toggleFlag(userId, flagStatus) {
        try {
            const response = await fetch(`/api/admin/users/${userId}/flag`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ is_flagged: flagStatus })
            });

            const result = await response.json();
            if (result.success) {
                loadUsers();
                alert(`User ${flagStatus ? 'flagged' : 'unflagged'} successfully`);
            }
        } catch (error) {
            console.error('Error toggling flag:', error);
            alert('Failed to update flag status');
        }
    }

    async function deleteUser(userId) {
        if (!confirm('Are you sure you want to delete this user?')) return;

        try {
            const response = await fetch(`/api/admin/users/${userId}`, {
                method: 'DELETE'
            });

            const result = await response.json();
            if (result.success) {
                loadUsers();
                alert('User deleted successfully');
            }
        } catch (error) {
            console.error('Error deleting user:', error);
            alert('Failed to delete user');
        }
    }

    async function editUser(userId) {
        try {
            const response = await fetch(`/api/admin/users/${userId}`);
            const user = await response.json();

            document.getElementById('editUserId').value = user.id;
            document.getElementById('editUsername').value = user.username;
            document.getElementById('editUserEmail').value = user.email;
            document.getElementById('editUserRole').value = user.role;

            document.getElementById('edit_user_modal').classList.add('open');
        } catch (error) {
            console.error('Error loading user:', error);
            alert('Failed to load user data');
        }
    }

    async function saveUser() {
        const userId = document.getElementById('editUserId').value;
        const email = document.getElementById('editUserEmail').value.trim();
        const role = document.getElementById('editUserRole').value;

        try {
            const response = await fetch(`/api/admin/users/${userId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ email, role })
            });

            const result = await response.json();
            if (result.success) {
                closeEditUserModal();
                loadUsers();
                alert('User updated successfully');
            }
        } catch (error) {
            console.error('Error updating user:', error);
            alert('Failed to update user');
        }
    }

    function openAddUserModal() {
        document.getElementById('add_user_modal').classList.add('open');
    }

    function closeAddUserModal() {
        document.getElementById('add_user_modal').classList.remove('open');
    }

    function closeEditUserModal() {
        document.getElementById('edit_user_modal').classList.remove('open');
    }

    async function loadSystemHealth() {
        const uptimeGauge = document.getElementById('uptimeGauge').getContext('2d');
        const dbGauge = document.getElementById('dbGauge').getContext('2d');
        const errorGauge = document.getElementById('errorGauge').getContext('2d');

        try {
            const response = await fetch('/api/admin/system_health');
            const health = await response.json();

            new Chart(uptimeGauge, {
                type: 'doughnut',
                data: {
                    datasets: [{
                        data: [health.uptime, 100 - health.uptime],
                        backgroundColor: ['#006400', '#e0e0e0']
                    }]
                },
                options: { cutout: '70%' }
            });
            document.getElementById('uptimeValue').textContent = `${health.uptime}%`;

            new Chart(dbGauge, {
                type: 'doughnut',
                data: {
                    datasets: [{
                        data: [health.db_response, 100 - health.db_response],
                        backgroundColor: ['#006400', '#e0e0e0']
                    }]
                },
                options: { cutout: '70%' }
            });
            document.getElementById('dbValue').textContent = `${health.db_response}ms`;

            new Chart(errorGauge, {
                type: 'doughnut',
                data: {
                    datasets: [{
                        data: [health.error_rate, 100 - health.error_rate],
                        backgroundColor: ['#FF0000', '#e0e0e0']
                    }]
                },
                options: { cutout: '70%' }
            });
            document.getElementById('errorValue').textContent = `${health.error_rate}%`;

            const ctx = document.getElementById('healthChart').getContext('2d');
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: health.history.map(h => new Date(h.timestamp).toLocaleDateString()),
                    datasets: [
                        { label: 'Uptime', data: health.history.map(h => h.uptime), borderColor: '#006400' },
                        { label: 'DB Response', data: health.history.map(h => h.db_response), borderColor: '#0000FF' },
                        { label: 'Error Rate', data: health.history.map(h => h.error_rate), borderColor: '#FF0000' }
                    ]
                },
                options: {
                    scales: {
                        y: { beginAtZero: true, ticks: { color: '#000000' } },
                        x: { ticks: { color: '#000000' } }
                    }
                }
            });
        } catch (error) {
            console.error('Error loading system health:', error);
        }
    }

    // Add this JavaScript to your admin dashboard to improve task assignment integration

// Enhanced task assignment functionality
async function loadTasks() {
    const tbody = document.querySelector('#tasksTable tbody');
    tbody.innerHTML = '';
    const assigneeSelect = document.getElementById('taskAssignee');
    assigneeSelect.innerHTML = '<option value="">Select Inspector</option>';

    try {
        const [tasksResponse, inspectorsResponse] = await Promise.all([
            fetch('/api/admin/tasks'),
            fetch('/api/admin/inspectors')
        ]);
        const tasks = await tasksResponse.json();
        const inspectors = await inspectorsResponse.json();

        // Populate inspector dropdown
        inspectors.forEach(inspector => {
            const option = document.createElement('option');
            option.value = inspector.id;
            option.textContent = inspector.name;
            assigneeSelect.appendChild(option);
        });

        // Populate tasks table
        tasks.forEach(task => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td class="px-6 py-4 whitespace-nowrap">${task.id}</td>
                <td class="px-6 py-4 whitespace-nowrap">${task.title}</td>
                <td class="px-6 py-4 whitespace-nowrap">${task.assignee}</td>
                <td class="px-6 py-4 whitespace-nowrap">${task.due_date}</td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <span class="px-2 py-1 text-xs rounded ${getStatusClass(task.status)}">
                        ${task.status}
                    </span>
                </td>
            `;
            tbody.appendChild(row);
        });

        // Enhanced task assignment
        document.getElementById('assignTask').addEventListener('click', async () => {
            const title = document.getElementById('taskTitle').value.trim();
            const assignee = document.getElementById('taskAssignee').value;
            const dueDate = document.getElementById('taskDueDate').value;
            const details = document.getElementById('taskDetails').value.trim();

            if (!title || !assignee || !dueDate) {
                alert('Please fill in all required fields (Title, Assignee, Due Date)');
                return;
            }

            try {
                const response = await fetch('/api/admin/tasks', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        title,
                        assignee: parseInt(assignee),
                        due_date: dueDate,
                        details
                    })
                });

                const result = await response.json();
                if (result.success) {
                    // Clear form
                    document.getElementById('taskTitle').value = '';
                    document.getElementById('taskAssignee').value = '';
                    document.getElementById('taskDueDate').value = '';
                    document.getElementById('taskDetails').value = '';

                    // Reload tasks
                    loadTasks();

                    // Show success message
                    showNotification('Task assigned successfully!', 'success');
                } else {
                    showNotification('Failed to assign task: ' + (result.error || 'Unknown error'), 'error');
                }
            } catch (error) {
                console.error('Error assigning task:', error);
                showNotification('Failed to assign task. Please try again.', 'error');
            }
        });

    } catch (error) {
        console.error('Error loading tasks:', error);
        tbody.innerHTML = '<tr><td colspan="5" class="px-6 py-4 text-center">Error loading data</td></tr>';
        showNotification('Error loading tasks data', 'error');
    }
}

// Helper function to get status styling
function getStatusClass(status) {
    switch (status.toLowerCase()) {
        case 'pending':
            return 'bg-yellow-100 text-yellow-800';
        case 'in progress':
            return 'bg-blue-100 text-blue-800';
        case 'completed':
            return 'bg-green-100 text-green-800';
        default:
            return 'bg-gray-100 text-gray-800';
    }
}

// Enhanced notification system
function showNotification(message, type = 'info') {
    const notification = document.createElement('div');
    notification.className = `fixed top-4 right-4 z-50 px-4 py-2 rounded-md shadow-lg ${getNotificationClass(type)}`;
    notification.textContent = message;

    document.body.appendChild(notification);

    // Auto remove after 3 seconds
    setTimeout(() => {
        notification.remove();
    }, 3000);
}

function getNotificationClass(type) {
    switch (type) {
        case 'success':
            return 'bg-green-500 text-white';
        case 'error':
            return 'bg-red-500 text-white';
        case 'warning':
            return 'bg-yellow-500 text-white';
        default:
            return 'bg-blue-500 text-white';
    }
}

// Enhanced task monitoring with real-time updates
function startTaskMonitoring() {
    setInterval(async () => {
        // Check for task status updates
        try {
            const response = await fetch('/api/admin/tasks');
            const tasks = await response.json();

            // Update task table if modal is open
            const modal = document.getElementById('task_assignment_modal');
            if (modal && modal.classList.contains('open')) {
                updateTaskTable(tasks);
            }

            // Check for overdue tasks
            const overdueTasks = tasks.filter(task => {
                const dueDate = new Date(task.due_date);
                const now = new Date();
                return dueDate < now && task.status !== 'Completed';
            });

            if (overdueTasks.length > 0) {
                updateOverdueTaskAlert(overdueTasks.length);
            }

        } catch (error) {
            console.error('Error monitoring tasks:', error);
        }
    }, 60000); // Check every minute
}

function updateTaskTable(tasks) {
    const tbody = document.querySelector('#tasksTable tbody');
    if (!tbody) return;

    tbody.innerHTML = '';
    tasks.forEach(task => {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td class="px-6 py-4 whitespace-nowrap">${task.id}</td>
            <td class="px-6 py-4 whitespace-nowrap">${task.title}</td>
            <td class="px-6 py-4 whitespace-nowrap">${task.assignee}</td>
            <td class="px-6 py-4 whitespace-nowrap">${task.due_date}</td>
            <td class="px-6 py-4 whitespace-nowrap">
                <span class="px-2 py-1 text-xs rounded ${getStatusClass(task.status)}">
                    ${task.status}
                </span>
            </td>
        `;
        tbody.appendChild(row);
    });
}

function updateOverdueTaskAlert(count) {
    const alertBadge = document.getElementById('alertBadge');
    if (alertBadge) {
        const currentCount = parseInt(alertBadge.textContent) || 0;
        alertBadge.textContent = currentCount + count;
        alertBadge.style.display = 'flex';
    }
}

// Initialize task management when DOM loads
document.addEventListener('DOMContentLoaded', () => {
    startTaskMonitoring();

    // Set default due date to tomorrow
    const tomorrow = new Date();
    tomorrow.setDate(tomorrow.getDate() + 1);
    const taskDueDateInput = document.getElementById('taskDueDate');
    if (taskDueDateInput) {
        taskDueDateInput.value = tomorrow.toISOString().split('T')[0];
    }
});

// Enhanced form validation
function validateTaskForm() {
    const title = document.getElementById('taskTitle').value.trim();
    const assignee = document.getElementById('taskAssignee').value;
    const dueDate = document.getElementById('taskDueDate').value;

    if (!title) {
        showNotification('Task title is required', 'error');
        return false;
    }

    if (!assignee) {
        showNotification('Please select an inspector', 'error');
        return false;
    }

    if (!dueDate) {
        showNotification('Due date is required', 'error');
        return false;
    }

    const dueDateObj = new Date(dueDate);
    const today = new Date();
    today.setHours(0, 0, 0, 0);

    if (dueDateObj < today) {
        showNotification('Due date cannot be in the past', 'error');
        return false;
    }

    return true;
}

// Add keyboard shortcuts for task management
document.addEventListener('keydown', (e) => {
    // Ctrl+Shift+T to open task assignment modal
    if (e.ctrlKey && e.shiftKey && e.key === 'T') {
        const taskModal = document.getElementById('task_assignment_modal');
        if (taskModal) {
            openModal('task_assignment');
        }
    }

    // Escape to close modals
    if (e.key === 'Escape') {
        const openModals = document.querySelectorAll('.modal.open');
        openModals.forEach(modal => {
            modal.classList.remove('open');
        });
    }
});

// Quick task assignment from inspection forms
function quickAssignTask(inspectionId, inspectionType) {
    const title = `Follow-up on ${inspectionType} Inspection #${inspectionId}`;
    const details = `Please review and follow up on the ${inspectionType.toLowerCase()} inspection (ID: ${inspectionId}).`;

    // Pre-fill task form
    document.getElementById('taskTitle').value = title;
    document.getElementById('taskDetails').value = details;

    // Open task assignment modal
    openModal('task_assignment');
}

// Export task data
function exportTasks() {
    fetch('/api/admin/tasks')
        .then(response => response.json())
        .then(tasks => {
            const csv = convertToCSV(tasks);
            downloadCSV(csv, 'tasks_export.csv');
        })
        .catch(error => {
            console.error('Error exporting tasks:', error);
            showNotification('Failed to export tasks', 'error');
        });
}

function convertToCSV(data) {
    if (data.length === 0) return '';

    const headers = Object.keys(data[0]);
    const csvContent = [
        headers.join(','),
        ...data.map(row => headers.map(header => `"${row[header] || ''}"`).join(','))
    ].join('\n');

    return csvContent;
}

function downloadCSV(csvContent, filename) {
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');

    if (link.download !== undefined) {
        const url = URL.createObjectURL(blob);
        link.setAttribute('href', url);
        link.setAttribute('download', filename);
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }
}
    </script>
</body>
</html>